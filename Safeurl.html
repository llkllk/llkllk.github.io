<!DOCTYPE html>
<html lang="zh">
<head>
<title>祎开发</title>
<!-- CSP 策略：限制 iframe 只能加载 yidev.cn 域名 -->
<meta http-equiv="Content-Security-Policy" content="frame-src https://*.yidev.cn https://yidev.cn http://*.yidev.cn http://yidev.cn; default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
<script src="jquery.min.js"></script>
<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
<style>
  *{margin:0;padding:0;font-family: "Microsoft YaHei";color: #fff;}
  body,div,form,input,li,ol,p,textarea,ul{margin:0;padding:0;font-family: "Microsoft YaHei";color: #fff;}
  body{background:#fff;color:#3f3f3f;font-family:Apple LiGothic Medium,SimHei,Geneva,Arial,Helvetica,sans-serif;-webkit-tap-highlight-color:transparent;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-appearance:none;width:100%;font-size:12px;}
  body p {color: white;text-align: center;line-height: 25px;}
  #zl{overflow:hidden;}
  .error-message {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 20px rgba(0,0,0,0.2);
    z-index: 9999;
    text-align: center;
  }
  .error-message h3 {
    color: #e74c3c;
    margin-bottom: 10px;
    font-size: 18px;
  }
  .error-message p {
    color: #666;
    font-size: 14px;
  }
</style>
</head>
<body style="text-align: center;">
<div class="error-message" id="error-message">
  <h3>⚠️ 安全警告</h3>
  <p id="error-text"></p>
</div>
<div id="Zl"><iframe id="preview" src="" frameborder="0" width="100%" height="910px" scrolling='auto'></iframe></div>
<script>
  // 允许的域名白名单（防止被篡改，使用立即执行函数封装）
  var ALLOWED_DOMAINS = Object.freeze(['yidev.cn', 'www.yidev.cn']);

  // 获取 URL 参数
  function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    var results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
  }

  // 显示错误信息
  function showError(message) {
    $('#error-text').text(message);
    $('#error-message').show();
    $('#Zl').hide();
  }

  // 验证 URL 是否在白名单内
  function isValidUrl(urlString) {
    try {
      var url = new URL(urlString);

      // 只允许 http 和 https 协议
      if (url.protocol !== 'https:' && url.protocol !== 'http:') {
        throw new Error('只允许 HTTP/HTTPS 协议');
      }

      // 检查域名是否在白名单中
      var hostname = url.hostname.toLowerCase();
      var isAllowed = false;

      for (var i = 0; i < ALLOWED_DOMAINS.length; i++) {
        var domain = ALLOWED_DOMAINS[i];
        if (hostname === domain || hostname.endsWith('.' + domain)) {
          isAllowed = true;
          break;
        }
      }

      if (!isAllowed) {
        throw new Error('域名 "' + hostname + '" 不在允许列表中，只允许 yidev.cn 及其子域名');
      }

      return true;
    } catch (e) {
      console.error('URL 验证失败:', e.message);
      showError(e.message);
      return false;
    }
  }

  // 设置 iframe 源地址
  var targetUrl = getUrlParameter('url') || 'https://yidev.cn';

  // 验证 URL
  if (!isValidUrl(targetUrl)) {
    // 错误已在 isValidUrl 中显示
  } else {
    // 使用 sandbox 限制：允许弹窗但阻止逃逸到父窗口
    $("#Zl").html('<iframe width="100%" id="preview" name="contentFrame" src="' + targetUrl + '" frameborder="0" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>');

    $(document).ready(function(){
      function fix_height(){
        $("#preview").attr("height", (($(window).height())-5) + "px");
      }
      $(window).resize(function(){
        fix_height();
      }).resize();

      // 仅对同源内容尝试注入 base 标签
      var iframe = $("#preview")[0];
      if (iframe) {
        iframe.onload = function() {
          try {
            var iframeWindow = iframe.contentWindow;
            var iframeDoc = iframeWindow.document;

            // 检查是否已经有 base 标签
            var existingBase = iframeDoc.querySelector('base');
            if (existingBase) {
              existingBase.setAttribute('target', '_self');
            } else {
              var base = iframeDoc.createElement('base');
              base.setAttribute('target', '_self');
              var head = iframeDoc.head || iframeDoc.getElementsByTagName('head')[0];
              if (head) {
                head.insertBefore(base, head.firstChild);
              }
            }

            // 拦截 window.open
            var originalOpen = iframeWindow.open;
            iframeWindow.open = function(url, name, features) {
              if (!name || name === '_blank' || name === '_top' || name === '_parent') {
                iframeWindow.location.href = url;
                return null;
              }
              return originalOpen.call(iframeWindow, url, name, features);
            };
          } catch (e) {
            // 跨域时无法注入，依赖 sandbox 属性阻止弹窗
          }
        };

        iframe.contentWindow.focus();
      }
    });

    // 防止 URL 被篡改 - 监听 URL 变化
    var lastUrl = window.location.href;
    setInterval(function() {
      if (window.location.href !== lastUrl) {
        var newTargetUrl = getUrlParameter('url') || 'https://yidev.cn';
        if (!isValidUrl(newTargetUrl)) {
          $('#Zl').html('');
        }
        lastUrl = window.location.href;
      }
    }, 1000);

    // 防止 iframe 被恶意替换或修改
    var observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.target.id === 'preview') {
          var currentSrc = mutation.target.getAttribute('src');
          if (currentSrc && !isValidUrl(currentSrc)) {
            showError('检测到 iframe src 被非法篡改');
            mutation.target.src = 'about:blank';
          }
        }
      });
    });

    // 监听 iframe 的 src 属性变化
    if (document.getElementById('preview')) {
      observer.observe(document.getElementById('preview'), {
        attributes: true,
        attributeFilter: ['src']
      });
    }
  }
</script>
</br></br></br>
</body>
</html>